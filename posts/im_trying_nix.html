<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>

   <!-- Standard site meta information -->
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>I am trying nixos &larr; Either a Blog &larr Tim Sears</title>
   <meta name="author" content="Tim" Sears />

   <!--link rel='openid.server' href='http://www.myopenid.com/server' / -->
   <!-- link rel='openid.delegate' href='http://timsears.githun.io' / -->

   <link rel="start" href="../" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="../css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="../css/screen.css" type="text/css" media="all" />
   <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
   <link rel="stylesheet" href="../css/widgets.css" type="text/css" media="all" />
   <link rel="stylesheet" href="../css/amjr.css" type="text/css" media="all" />

 	<meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@timothydsears">
    <meta name="twitter:site" content="@timothydsears">
    <meta name="twitter:title" content="I am trying nixos">
    <meta name="twitter:description" content="I am trying nixos. Only 10 days in.">

<!-- MathJax configuration and loading -->
<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		extensions: ["tex2jax.js"],
		jax: ["input/TeX", "output/HTML-CSS"],
		tex2jax: {
			inlineMath: [ ["\\(","\\)"] ],
			displayMath: [ ["\\[","\\]"] ],
			processEscapes: true
		},
		TeX: { equationNumbers: { autoNumber: "AMS" } },
		"HTML-CSS": { availableFonts: ["TeX"] }
	});
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>

</head>

<body id="Blog">

<div id="site">
  <div id="header">
<h1>
	<a href="../" title="Maybe Blog? :-)">Either a Blog</a>
	<span class="byline">&larr; <a href="../">Tim Sears</a></span>
</h1>
<ul class="nav">
  <li><a class="home" href="../">Home</a></li>
  <li><a class="about" href="../about.html">About</a></li>
  <li><a class="archive" href="../archive.html">Archive</a></li>
  <li><a class="recommended" href="../recommended.html">Recommended</a></li>
</ul>
</div>

<div id="page">

<h1 class="emphnext">I am trying nixos</h1>

<h1 id="my-setup">My setup<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></h1>
<p>I have been running ubuntu 12.04 on VMWare Fusion. I started using nixos on October 6th.</p>
<p>That’s just 10 days ago.</p>
<p><em>Disclaimer: All opinions herein are subject to change.</em></p>
<h1 id="my-current-setup-has-its-pluses">My current setup has its pluses…</h1>
<ul>
<li>Ubuntu is very stable, never crashes. I have never felt pressure to upgrade from 12.04.</li>
<li>Security upgrades have never broken anything.</li>
<li><code>sudo apt-get install somepackage</code> rarely fails to provide what I need.</li>
<li>Binary/libc compatible with our servers in the cloud. Easy deployment on minimially configured production box.</li>
</ul>
<h1 id="and-its-minuses">…and its minuses</h1>
<ul>
<li>ghc is <em>always</em> behind in the package manager (ubuntu 12.04 ~ ghc 7.4). I want to work on projects that require ghc 7.8.</li>
<li>My dev box is used for building production code.</li>
<li>Only <em>my</em> code is should break a build. Therefore I don’t want to install software that could break my code.</li>
<li>Setting up a dev box for a new person requires reading lots of old and potentially outdated notes to collect and install all sorts of dependencies together on a new box.</li>
<li>The new cabal sandboxes work, but lots of code gets recompiled and reinstalled on every project.</li>
<li>It’s “hard” to run multiple versions of ghc. (I might just be lazy here.)</li>
</ul>
<h1 id="some-suggestions-i-have-heard">Some suggestions I have heard</h1>
<p>“Bro, you’re running a mac. Just use brew.”</p>
<ul>
<li>I have tried everything on mac. Remember fink, ports?</li>
<li>brew is great. It makes make osx 99% like linux. Not nearly close enough.</li>
<li>Did you ever cross-compile with ghc?</li>
</ul>
<p>“Dude, you like the bleeding edge. Try Arch.”</p>
<ul>
<li>No, it just looks that way because I use Haskell.</li>
<li>I did run Arch for over a year. Arch is fun, has a great community and a fantastic wiki, but if you want to update one thing you need to update everything. You tend to run only the latest software and it is hard to roll back.</li>
<li>I broke my system more than once.</li>
</ul>
<h1 id="why-nixos">Why Nixos?</h1>
<p>As a Haskeller how could I resist this kind of marketing?</p>
<blockquote>
<p>Nixos: The Purely Functional Linux Distribution</p>
</blockquote>
<p>But wait there’s more!</p>
<blockquote>
<p>Built on top of the Nix package manager, it is completely declarative…</p>
</blockquote>
<p>Whoa.</p>
<h1 id="real-reasons">Real reasons:</h1>
<p>The potential…</p>
<ul>
<li>for alternative environents to live safely on the same box. (nix)</li>
<li>to encode the configuration of a development box suitable for my company’s project. (nixos, nix).</li>
<li>to <em>calculate</em> an entire machine and deploy it to the cloud. (nixops)</li>
<li>Escape cabal hell forever without pinning all my dependencies.</li>
<li>Let’s try it out…</li>
</ul>
<h1 id="install">Install</h1>
<p>Boot a new machine from a .iso file, then…</p>
<pre><code>$ fdisk /dev/sda # enter options n,p,1,w in sequence
$ mkfs.ext4 -j -L nixos /dev/sda1
$ mount LABEL=nixos /mnt
$ nixos-generate-config --root /mnt
$ nano /mnt/etc/nixos/configuration.nix # copy/paste a configuration.nix.
$ nixos-install
$ reboot</code></pre>
<p>While it is truly possible to get a system going this way, I edited configuration about 20 times before I had it just right for my dev box. If you break something the old configuration is available from the boot menu.</p>
<p>Here’s my config file…</p>
<pre><code>[timsears@nixos:~/blog/drafts]$ cat /etc/nixos/configuration.nix
# Edit this configuration file to define what should be installed on
# your system.  Help is available in the configuration.nix(5) man page
# and in the NixOS manual (accessible by running ‘nixos-help’).

{ config, pkgs, ... }:

{
  imports =
    [ # Include the results of the hardware scan.
      ./hardware-configuration.nix
    ];

  # Use the GRUB 2 boot loader.
  boot.loader.grub.enable = true;
  boot.loader.grub.version = 2;
  # Define on which hard drive you want to install Grub.
  boot.loader.grub.device = &quot;/dev/sda&quot;;

  swapDevices = [ { device = &quot;/swapfile1&quot;; } ];

  networking.hostName = &quot;nixos&quot;; # Define your hostname.
  # networking.wireless.enable = true;  # I'm on a vm. Not needed.

  # Select internationalisation properties.
  i18n = {
    consoleFont = &quot;lat9w-16&quot;;
    consoleKeyMap = &quot;us&quot;;
    defaultLocale = &quot;en_US.UTF-8&quot;;
  };

  environment.systemPackages = with pkgs; [
    (pkgs.texLiveAggregationFun { paths = [ pkgs.texLive pkgs.texLiveExtra pkgs.texLiveBeamer ]; })
     wget
     curl
     emacs
     xlibs.xmessage
     xfce.terminal
   ];

  nixpkgs.config.allowUnfree = true;

  time.timeZone = &quot;US/Pacific&quot;;
  security.sudo.wheelNeedsPassword = false;

  # List services that you want to enable:

  # Enable the OpenSSH daemon.
  services.openssh.enable = true;

  services.xserver = { displayManager.slim.autoLogin = true;
                       displayManager.slim.defaultUser = &quot;timsears&quot;;
                       windowManager.awesome.enable = true;
                       windowManager.default = &quot;awesome&quot;;
                       # only seem to affect login screen
                       virtualScreen = { x = 1920; y = 1200; };
                       resolutions = [{ x = 1920; y = 1200; }] ;
                       enable = true;
                       layout = &quot;us&quot;;
                        };

  # Define a user account. Don't forget to set a password with ‘passwd’.
  users.extraUsers.guest = {
    name = &quot;timsears&quot;;
    group = &quot;users&quot;;
    extraGroups = [&quot;wheel&quot;];
    uid = 1000;
    createHome = true;
    home = &quot;/home/timsears&quot;;
    shell = &quot;/run/current-system/sw/bin/bash&quot;;
   };
}</code></pre>
<h1 id="configure-global">Configure (Global)</h1>
<p>There are at least three levels of configuration. Global-, user- and project- level. We already saw global level. Software packages can be enabled here…</p>
<pre><code>nano /etc/nixos/configuration.nix # make changes
nixos-rebuild switch</code></pre>
<p>It’s really about that simple.</p>
<h1 id="configure-user">Configure (User)</h1>
<p>You are encouraged to install software as a user with <code>nix-env -i somepackage</code> See installed packages with <code>nix-env -q</code>. Here’s mine so far…</p>
<pre><code>cabal-install-1.16.0.2
cabal2nix-1.61
chromium-stable-with-plugins-35.0.1916.114
ghc-7.6.3-wrapper
git-1.9.4
gnome-terminal-3.10.2
haskell-hakyll-ghc7.6.3-4.5.1.0
haskell-haskell-platform-ghc7.6.3-2013.2.0.0
haskell-hoogle-ghc7.6.3-4.2.32
hasktags-0.68.7
nix-repl-1.7-1734e8a
structured-haskell-mode-1.0.2
w3m-0.5.3
xkill-1.0.4
xpdf-3.03</code></pre>
<p>Eventually I will convert that to a nix expression. I expect to write a few custon expressions to install the odd missing package (like easyVision).</p>
<h1 id="configure-project">Configure (Project)</h1>
<p><strong>Here’s our first major win</strong></p>
<p>You can have multiple profiles per user. (I haven’t used that feature yet.)</p>
<p>Or you can customize the build environment for each project.</p>
<p>You can put a nix expression in a project directory. Here’s a file that lives in a project I have been working on: <code>~/timsears/code/probmonad/default.nix</code></p>
<pre><code>{ pkgs ? (import &lt;nixpkgs&gt; {})
#, haskellPackages ? pkgs.haskellPackages_ghc763
, haskellPackages ? pkgs.haskellPackages_ghc782
}:

let inherit (haskellPackages) cabal cabalInstall
    distributive comonad; # Haskell dependencies here
in

haskellPackages.cabal.mkDerivation (self: {
  pname = &quot;probmonad&quot;;
  version = &quot;0.1.0.0&quot;;
  src = &quot;./.&quot;;
  isLibrary = false;
  isExecutable = true;
  buildTools = with haskellPackages; [cabalInstall];
  buildDepends = with haskellPackages; [ comonad distributive];
  meta = {
    license = self.stdenv.lib.licenses.gpl3;
    platforms = self.ghc.meta.platforms;
  };
  noHaddock = true;
})</code></pre>
<h1 id="why-this-is-great">Why this is great</h1>
<ul>
<li><p>The default.nix file is mostly generated by a utility <code>cabal2nix</code>.</p></li>
<li><p>I can comment out one line to switch ghc versions distributions. I just enter <code>nix-shell</code> to drop into the chosen environment. <strong>Other projects are unaffected.</strong></p></li>
<li><p>The first time you switch versions nix downloads and caches all the necessary packages. (Lazy evaluation!)</p></li>
<li><p>I can even hide my default environment to make sure there are no hidden dependencies in my build expression.</p></li>
<li><p>Dependencies can be <em>anything</em>. Nix will install them for you if there is a nix expression available.</p></li>
</ul>
<h1 id="impressions-so-far">Impressions so far</h1>
<h2 id="the-good">The Good</h2>
<ul>
<li>Switching environments works well and fast after the initial setup. It’s really the first time I have been happy doing that.</li>
<li>The entire set of package expressions is in one git repo. That’s cool.</li>
<li>You literally edit one file to configure your box globally. That’s really cool.</li>
<li>Rolling back a bad configuration is really easy.</li>
</ul>
<h2 id="the-bad">The Bad</h2>
<ul>
<li>You <em>must</em> learn how nix expressions work.</li>
<li>The docs aren’t great yet. You must read the code!</li>
<li>Nobody told me to read the manual’s Appendix B first to see all the settings available for configureing your system. There, I told <em>you</em>.</li>
<li>Sometimes blogs are more helpful than the docs.</li>
</ul>
<h2 id="the-i-dont-know">The I Don’t Know</h2>
<ul>
<li>nixops looks powerful. I want to try it.</li>
<li>Some things are still arcane or rough around the edges (installing latex).</li>
<li>Will I be able to write an expression for Intel IPP? It’s got a weird installer.</li>
</ul>
<p>[EDIT: There is a video of the talk I gave <a href="http://looprecur.com/blog/from-ubuntu-to-nixos/">here</a> and a Reddit discussion <a href="http://www.reddit.com/r/haskell/comments/2k3oy2/from_ubuntu_to_nixos_video/">here</a>]</p>
<p><a href="http://localhost:8000/slides/imtryingnix/imtryingnix.html">Update 1–18–2015: Slides for the talk, with some minor updates are here</a></p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>This blog enty was based on a talk I gave at Hacker Dojo earlier today.<a href="#fnref1">↩</a></p></li>
</ol>
</div>


<address class="signature">
        <a class="author" href="http://blog.timsears.com">Tim Sears</a>
  <span class="date">October 16, 2014</span>
  </address>

</div>
<address id="feed" class="quiet right">Subscribe: <a href="../atom.xml" title="Subscribe to Atom feed"><em>Atom Feed</em></a></address>


<!-- Disqus Comments -->
<div id="disqus_thread"></div>

<!-- Enable Disqus comments -->
<script type="text/javascript">
        var disqus_iframe_css = "http://timsears.github.io/css/screen.css";
        var disqus_title = "I am trying nixos";
        var disqus_message = "I am trying nixos. Only 10 days in.";
        var disqus_identifier = "posts/im_trying_nix.markdown";
</script>
<script type="text/javascript" src="http://disqus.com/forums/timsears/embed.js"></script>

<noscript>
    <a href="http://timsears.disqus.com/?url=ref">View the discussion thread.</a>
</noscript>



    <!-- Footer with copyright and contact information -->
  <div id="footer">
	<address>
		<span class="copyright">
			Content by Tim Sears <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(Licensed under Creative Commons)</a>
		</span>
		<span class="engine">
                  Design by 
		  <a href="http://mark.reid.name">Mark Reid</a>			Powered by 
		  <a href="http://jaspervdj.be/hakyll/" title="A static, minimalist, Haskell-powered CMS">Hakyll</a>
		</span>
	</address>
  </div>

</div>


<!-- Google Analytics script -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54483715-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>



